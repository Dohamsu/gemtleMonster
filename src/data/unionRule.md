# 연금술 슬라임 조합 시스템 설계 (컨셉만 정리)

## 1. 목표

- 슬라임/몬스터 조합식을 **수십~수백 개 이상**으로 확장 가능한 구조로 설계한다.
- **현실 세계 정보(시간, 날짜, 날씨, 디바이스, 플레이 행동)**까지 조합 조건으로 활용할 수 있게 한다.
- 플레이어가 “조합하기”를 눌렀을 때:
  - 외부 API 호출이 전혀 없고
  - 무거운 DB 연산 없이
  - 이미 메모리에 준비된 정보(컨텍스트)를 기반으로만 **빠르게 조합 결과를 판정**하는 것을 목표로 한다.

---

## 2. 핵심 개념(도메인)

### 2.1 재료 (Material)

- 의미: 연금술에 사용되는 기본 요소.
- 예시: `잎사귀`, `물방울`, `불씨`, `작은 돌`, `먼지`, `룬 조각` 등.
- 갖는 개념적 속성:
  - 내부 코드 (예: `leaf`, `water_drop` 등)
  - 표시 이름 (다국어 지원 가능)
  - 재료 타입 (기본 재료, 희귀 재료, 이벤트 한정 재료 등)
  - 희귀도(등급)

### 2.2 몬스터/슬라임 (Monster / Slime)

- 의미: 조합 결과로 생성되는 존재.
- 예시: `그린 슬라임`, `블루 슬라임`, `문라이트 슬라임`, `카오스 슬라임` 등.
- 갖는 개념적 속성:
  - 내부 코드 (예: `slime_green`, `slime_moonlight` 등)
  - 표시 이름 (다국어)
  - 등급/티어 (일반, 희귀, 특수, 보스 등)
  - 기본 스탯 (체력, 공격력, 방어력, 이동속도, 특수 능력 등)

### 2.3 조합식 (Recipe)

- 의미: **“어떤 재료들을 어떤 환경에서 조합하면 어떤 몬스터가 나온다”** 라는 규칙의 헤더.
- 갖는 개념적 속성:
  - 결과 몬스터 정보
  - 기본 성공 확률 (예: 100%, 60% 등)
  - 필요한 최소 연금술 레벨
  - 숨겨진 레시피인지 여부 (도감에서 처음엔 안 보이게 할지)
  - 현재 사용 가능한 레시피인지 여부(비활성화 처리용)

### 2.4 조합 재료 목록 (Recipe Ingredient)

- 의미: 하나의 조합식에 포함된 각각의 재료 정보.
- 특징:
  - 하나의 조합식은 여러 재료를 가진다.
  - 각 재료는:
    - 어느 조합식에 속하는지
    - 어떤 재료인지
    - 몇 개가 필요한지
    - UI 상 몇 번째 슬롯에 배치되는지
    - 필수 재료인지, 선택 재료인지
    - “핵심 재료”, “촉매” 같은 역할 태그를 가질 수 있다.

### 2.5 조합 조건 (Recipe Condition)

- 의미: **레시피가 발동하기 위한 환경/상태 조건**.
- 구조적 개념:
  - 조건 타입 (예: 시간대, 언어, 날씨, 디바이스 등)
  - 조건 설정값 (해당 타입에 따라 달라지는 세부 설정)
- 예시:
  - 현실 시간 새벽 2시~4시 사이에만 발동
  - 한국어 클라이언트에서만 발동
  - 비/눈이 오는 날씨에서만 발동
  - 모바일에서 접속했을 때만 발동
  - 탭이 5분 이상 백그라운드에 있었을 때만 발동
  - 최근 10분 동안 조합 실패가 5회 이상일 때 발동

### 2.6 플레이어별 레시피 발견 정보 (Player Recipe Discovery)

- 의미: 전체 레시피 중에서 **플레이어가 발견/해금한 레시피 목록**.
- 용도:
  - 연금술 도감 UI에서 “알려진 레시피”만 보여줄 때 사용.
  - 처음에는 비밀 레시피로 숨겨두고, 특정 조건(성공 시, NPC 이벤트 등)으로 해금.

---

## 3. 조합 컨텍스트 (Alchemy Context)

### 3.1 컨셉

- 조합 시점에 외부 정보를 매번 가져오지 않고,  
  **“조합에 필요한 모든 환경 정보”를 미리 모아둔 한 덩어리 데이터**를 사용한다.
- 이 덩어리를 `AlchemyContext`라고 부른다(이름은 바뀌어도 됨).
- 이 컨텍스트는:
  - 로그인 시
  - 연금술 화면 진입 시
  - 혹은 일정 주기마다
  - 서버/클라이언트에서 갱신한다.

### 3.2 컨텍스트에 포함되는 정보(개념)

컨텍스트에는 대략 다음과 같은 정보가 담긴다:

1. **현재 시각 정보**
   - 게임 내 시간 (시, 일차, 낮/밤 여부 등)
   - 현실 시간 (시, 요일 등)

2. **언어/지역**
   - 클라이언트 언어 코드 (예: `ko`, `en`, `ja` 등)
   - 대략적인 국가 정보 (예: `KR`, `JP`, `ES` 등)

3. **날씨/기온**
   - 현재 날씨 타입 (맑음, 비, 눈, 흐림, 폭풍 등)
   - 현재 기온(°C)
   - 이 정보는 날씨 API에서 **미리** 받아놓고 컨텍스트에 저장해 둔다.

4. **디바이스/플랫폼**
   - 디바이스 유형 (모바일, 데스크톱)
   - 운영체제 (iOS, Android, Windows, macOS 등)
   - 브라우저 종류 (Chrome, Safari, Firefox 등)
   - 다크 모드 사용 여부

5. **세션/플레이 행동**
   - 현재 탭이 백그라운드에 있었던 시간(초)
   - 연속 접속 일수
   - 오늘 하루 누적 플레이 시간(분)
   - 최근 특정 시간 동안의 연금술 조합 실패 횟수

6. **전역 이벤트 상태**
   - 특정 기간 이벤트 여부 (예: 할로윈 이벤트 중인지)
   - 전역 버프 주간 여부 (예: “비 오는 주간” 같은 컨셉)

---

## 4. 조합 처리 흐름 (로직 개념)

### 4.1 입력 요소

- 플레이어가 선택한 재료 목록
- 플레이어 상태 (연금술 레벨, 인벤토리 등)
- 연금술 컨텍스트 (`AlchemyContext`에 해당하는 환경 정보)

### 4.2 단계별 처리 요약

1. **재료 키 생성**
   - 선택된 재료들의 ID 혹은 코드를 정렬한다.
   - 정렬된 값들을 `'|'` 같은 구분자로 이어 붙여 하나의 문자열 키를 만든다.
   - 예: `[잎사귀, 잎사귀, 물방울]` → `잎사귀|잎사귀|물방울`
   - 재료 순서를 신경 쓰지 않아도 되도록, **정렬 후 키 생성**이 핵심.

2. **레시피 후보 조회 (재료 기반)**
   - 미리 메모리(혹은 캐시)에 “재료 키 → 레시피 리스트” 형태의 맵을 만들어 둔다.
     - 예:  
       - `잎사귀|잎사귀` → 그린 슬라임 레시피  
       - `잎사귀|물방울` → 문라이트 슬라임, 썬파이어 슬라임 등
   - 만들어둔 키로 맵에서 레시피 후보 리스트를 가져온다.
   - 이 단계에서 이미 **전체 레시피 중 일부만** 필터링되어 성능을 확보한다.

3. **조건 검사**
   - 각 레시피에는 여러 개의 조건들이 붙어 있다.
     - 예: 언어 조건, 시간 조건, 날씨 조건 등
   - 각 조건은:
     - “조건 타입”과
     - “조건 설정값”을 가지고 있고,
   - 컨텍스트에 담긴 정보와 비교하여 **통과 / 실패**를 판정한다.
   - 해당 레시피의 모든 조건이 통과한 경우에만 “사용 가능한 레시피”로 남긴다.

4. **최종 레시피 선택**
   - 사용 가능한 레시피가 없으면 → 조합 실패 처리.
   - 하나만 있다면 → 그 레시피가 최종 선정.
   - 여러 개라면:
     - 우선순위 규칙(희귀도, 숨겨진 레시피 여부 등)
     - 또는 가중치 기반 랜덤 선택 등을 적용해서 하나를 뽑는다.

5. **성공 확률 판정**
   - 선택된 레시피의 기본 성공 확률을 가져온다.
   - 여기에:
     - 플레이어의 연금술 레벨
     - 연금술 시설/장비
     - 이벤트 버프/디버프
   - 등을 반영해 최종 성공 확률을 계산한다.
   - 랜덤 값을 한 번 뽑아 최종 성공/실패를 판정한다.

6. **결과 처리**
   - 성공 시:
     - 결과 몬스터/슬라임 생성
     - 도감/레시피 해금 처리(처음 발견한 레시피라면)
   - 실패 시:
     - 재료 일부/전체 소모
     - 실패 전용 슬라임 생성, 실패 연출 등
     - 최근 실패 횟수 증가(세션 정보 업데이트)

---

## 5. 조건 타입 설계(컨셉 목록)

### 5.1 게임 세계 관련 조건

- **게임 내 시간대(TIME_RANGE)**  
  - 게임 세계의 낮/밤, 특정 시간대에만 발동하는 레시피
  - 예: 게임 내 밤 20시~4시만 가능한 문라이트 슬라임

- **시설/농장 레벨(FARM_LEVEL)**  
  - 특정 시설 레벨 이상에서만 가능한 고급 조합식

- **희귀 아이템 보유(RARE_ITEM)**  
  - 인벤토리에 특정 희귀 재료가 있어야만 조합 가능한 레시피

---

### 5.2 현실 시간/요일/날짜 조건

- **현실 시간 범위(REAL_TIME_RANGE)**  
  - 실제 시계 기준으로 새벽, 야근 시간 등에서만 발동
  - 예: 새벽 2~4시에만 가능한 “나이트워크 슬라임”

- **현실 날짜(REAL_DATE)**  
  - 크리스마스, 할로윈, 만우절 등 특정 날짜 한정 레시피

- **요일(WEEKDAY)**  
  - 금요일, 주말 전용 레시피 등

---

### 5.3 날씨/기온/지역 조건

- **현실 날씨(REAL_WEATHER)**  
  - 비/눈/폭풍우일 때만 가능한 레시피
  - 예: 비 오는 날에만 출현하는 레인 슬라임

- **현실 기온(REAL_TEMPERATURE)**  
  - 0°C 이하, 30°C 이상 등 극단적인 온도에서만 발동하는 레시피

- **국가/지역(GEO_COUNTRY)**  
  - 접속 국가에 따라 다른 슬라임 등장
  - 예: 한국 → 한글 슬라임, 일본 → 사쿠라 슬라임

---

### 5.4 디바이스/플랫폼/UI 조건

- **디바이스 타입(DEVICE_TYPE)**  
  - 모바일 전용, PC 전용 레시피

- **플랫폼/브라우저(PLATFORM)**  
  - 특정 OS나 브라우저에서만 발동하는 이스터에그

- **UI 설정(UI_PREFERENCE)**  
  - 다크모드일 때만 가능한 “다크매터 슬라임” 등

---

### 5.5 세션/플레이 행동 조건

- **탭 방치 시간(TAB_IDLE)**  
  - 탭이 백그라운드로 최소 몇 초 이상 유지되었을 때만 발동  
  - “진짜 방치형”을 상징하는 조건에 활용 가능

- **연속 접속 일수(LOGIN_STREAK)**  
  - 개근 보상 느낌으로, 일정 일수 이상 연속 접속 시 해금되는 레시피

- **일일 플레이 시간(DAILY_PLAYTIME)**  
  - 하루 누적 플레이 시간이 일정 시간 이상일 때 발동

- **최근 실패 횟수(RECENT_FAIL_COUNT)**  
  - 최근 일정 시간 동안 실패를 많이 한 유저에게만 열리는 “위로 슬라임” 레시피 등

---

### 5.6 전역/메타 조건

- **이벤트 플래그(EVENT_FLAG)**  
  - 서버 전체에 공통으로 적용되는 이벤트 상태  
  - 예: “할로윈 2025”, “비 오는 주간” 등

- **개발자 도구 감지(DEVTOOLS_DETECTED)**  
  - 개발자 도구가 열려 있을 때만 등장하는 “해커 슬라임” 같은 메타 이스터에그

- **다중 세션(MULTI_SESSION)**  
  - 같은 계정으로 여러 탭에서 접속 중일 때만 가능한 레시피

---

## 6. 성능 및 구조 설계 원칙

1. **조합 로직 내부에서는 외부 API를 호출하지 않는다.**
   - 날씨, 위치, 시간대 등은 미리 받아서 컨텍스트에 저장해 두고,
   - 조합 시에는 컨텍스트만 조회한다.

2. **레시피 후보는 재료 조합 키로 먼저 좁힌다.**
   - “재료 키 → 레시피 리스트” 맵을 준비해 두고,
   - 전체 레시피 중 일부만 조건 검사를 한다.

3. **조건 검사는 전부 순수 함수 형태로 설계한다.**
   - 입력: 조합 조건, 연금술 컨텍스트
   - 출력: 조건 충족 여부 (참/거짓)
   - 부수효과(네트워크, DB 변경 등)는 없도록 한다.

4. **전역 이벤트나 기간 조건은 별도의 전역 상태로 관리한다.**
   - 예: `isHalloween`, `isRainyWeek` 같은 플래그를 컨텍스트에 포함시켜,
   - 개별 레시피에서는 플래그 이름만 참조하게 만든다.

5. **컨텍스트 갱신은 상대적으로 드문 시점에만 한다.**
   - 로그인, 화면 진입, 일정 간격(예: 1분마다) 등
   - 조합 버튼은 자주 눌러도, 컨텍스트 계산은 자주 하지 않도록 설계한다.

---

## 7. 향후 확장 방향

- 슬라임/몬스터 도감:
  - 플레이어가 발견한 레시피만 보여주는 “연금술 레시피북” 시스템.
- 실패 패턴 확장:
  - 특정 조건에서 실패하면만 얻을 수 있는 “실패 전용 슬라임”이나 특수 재료.
- 버프/디버프 시스템 연동:
  - 시설, 장비, 버프 상태에 따라 조합 성공률, 결과 품질 등을 조정.
- 시드 데이터 설계:
  - 재료, 몬스터, 조합식, 조건을 JSON 형태 등으로 정리해서 초기 데이터로 사용.

