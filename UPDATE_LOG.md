# 2025-12-22 업데이트 (3차): 시설 관리 시스템 개선 및 신규 보너스 몬스터 추가

## 1. 시설 관리 시스템 안정화
- **미건설 시설 아이콘 오류 해결**: 레벨 0(미건설) 상태의 시설(벌목장, 마법의 탑)에서 아이콘이 깨지는 현상을 수정하여, 적절한 플레이스홀더(이모지)가 표시되도록 개선했습니다.
- **시설 데이터 동기화 이슈 해결**: 시설 최초 건설 및 업그레이드 시 `current_level` 데이터가 누락되어 발생하는 DB 제약 조건 위반(`not-null`) 에러를 수정했습니다.

## 2. 신규 보너스 몬스터 및 콘텐츠 확장
- **전문 생산 몬스터 추가**: 각 시설에 특화된 보너스를 제공하는 몬스터 2종을 새로 추가했습니다.
  - **비버 벌목꾼 (Beaver Lumberjack)**: 벌목장 생산량 대폭 증가 (SR 등급)
  - **현자 부엉이 (Wizard Owl)**: 마법의 탑 생산 속도 가속 (SR 등급)
- **기존 몬스터 리밸런싱**: '나무 골렘'과 '마력의 정령'의 특성을 각각 벌목장과 마법의 탑 보너스로 변경하여 활용도를 높였습니다.
- **연금술 레시피 추가**: 신규 몬스터 2종을 제작할 수 있는 연금술 레시피를 추가했습니다.

## 3. 시스템 검증 및 자산 통합
- **몬스터 배치 데이터 영속성 검증**: 시설 내 몬스터 배치 정보가 DB에 정상적으로 저장되고 로드되는지 검증 프로세스를 완료했습니다. 배열형(`_ids`)과 단일형(`_id`) 컬럼을 이중으로 활용하여 데이터 안전성을 확인했습니다.
- **사용자 커스텀 에셋 적용**: 사용자가 제공한 픽셀 아트 이미지(`beaver_warrior.png`, `owl_wizard.png`)를 신규 몬스터에 매핑 완료했습니다.

---

# 2025-12-22 업데이트 (4차): 연금술 UI 리뉴얼 및 테스트 커버리지 확대

## 1. UI 디자인 리뉴얼
- **연금술 결과 화면 개편**: 기존의 단조로운 모달 디자인을 상점/시설 탭과 통일된 **Dark RPG 테마**로 전면 리뉴얼했습니다.
  - 성공/실패 시의 시각적 피드백(Gold/Red 테두리, 배경 효과) 강화.
  - 성공 아이콘을 이모지에서 전용 이미지(`success_alchemy.png`)로 교체하여 완성도 향상.
  - 폰트 및 버튼 스타일을 게임 전반의 톤앤매너(`Space Grotesk`, 골드 엑센트)에 맞게 통일.

## 2. 테스트 시스템 확장
- **로그인/로그아웃 테스트 추가**: `Login.test.tsx`에 프로필 표시 및 로그아웃 기능에 대한 검증 코드를 추가하여 인증 로직의 신뢰성을 확보했습니다.
- **마이페이지 연동 테스트**: 게임 캔버스 내 '내 정보' 버튼을 통한 모달 호출부터 로그아웃까지의 사용자 시나리오를 자동화 테스트로 구현했습니다.
- **즐겨찾기 기능 테스트**: 레시피 및 재료 즐겨찾기 기능의 상태 관리와 로컬 스토리지 저장 로직을 검증하는 `Favorites.test.tsx`를 작성했습니다.

## 3. 편의성 기능 추가
- **즐겨찾기 시스템**: 자주 사용하는 레시피와 보유한 재료를 '즐겨찾기'로 등록하여 필터링해 볼 수 있는 기능을 인벤토리와 연금술 목록에 추가했습니다.

---

# 2025-12-22 업데이트: 생산 시설 확장 및 심연의 던전 추가

## 1. 신규 생산 시설 추가
- **벌목장 (Lumber Mill) & 마법 탑 (Magic Tower)**: 새로운 생산 시설 2종이 추가되었습니다.
  - **벌목장**: 나무 자재를 생산하며, 3단계 업그레이드 이미지가 적용되었습니다.
  - **마법 탑**: 마력 자원을 생산하며, 3단계 업그레이드 이미지가 적용되었습니다.
- **아이콘 및 데이터 연동**: `idleConst.json`에 시설 데이터(비용, 잠금 해제 조건, 생산 효율)를 정의하고, `FacilityIcon` 컴포넌트에서 레벨별 이미지가 올바르게 표시되도록 매핑했습니다.

## 2. 심연의 던전 (Abyss Dungeon) 콘텐츠
- **신규 던전**: '심연의 던전'이 추가되었습니다.
- **신규 몬스터**: 심연 테마의 몬스터 5종(심연 아귀, 산호 골렘, 심연 해파리, 새끼 크라켄, 불가사리 전사)이 추가되었습니다.
- **신규 재료**: 심연 몬스터가 드롭하는 재료(크라켄 먹물, 흑진주 등)가 추가되었습니다.
- **연금술 레시피**: 신규 몬스터를 제작할 수 있는 연금술 레시피가 등록되었습니다.

---

# 2025-12-02 업데이트: 연금술 조합 로직 개선 및 버그 수정

## 1. 연금술 조합 로직 개선
- **최소 수량 매칭 지원**: 정확한 수량이 아닌, 최소 필요 수량만 충족하면 조합이 가능하도록 변경했습니다. (예: 필요량보다 재료를 많이 넣어도 조합 성공)
- **최적 레시피 자동 선택**: 여러 레시피가 매칭될 경우, 재료를 가장 많이 소모하는(더 복잡한) 레시피가 우선적으로 선택되도록 로직을 개선했습니다.
## 2024-12-19
- **오프라인 보상 시스템 개선**
  - 기존 20% 효율 제한 제거 (100% 효율 적용)
  - 몬스터 배치 효과(속도, 생산량) 및 시설 생산 모드(저티어 생산) 반영 로직 추가
- **몬스터 초월(Awakening) 시스템 수정**
  - 초월 버튼 미작동 버그 수정 (이벤트 버블링 및 pointer-events 문제 해결)
  - 초월 재료 가치 가중치 적용 (재료의 초월 레벨만큼 가치 합산)
  - 최대 초월 레벨(5) 초과 방지 안전 장치 및 UI 경고 추가
- **전투 시스템 개선**
  - 전투 배속 기능 안정화 및 UI 수정

## 2024-12-18
## 2. 버그 수정
- **DB 함수 오류 수정**: `update_recipe_craft_count` 호출 시 발생하는 타입 불일치 오류를 수정하여 조합 카운트가 정상적으로 기록되도록 조치했습니다.

---

# 2025-12-18 업데이트: 시설 관리 시스템 안정화 및 모바일 UI 최적화

## 1. 시설 관리 및 자동 수집 시스템 복구
- **GameState 복구**: `useGameStore`에서 누락되었던 `assignedMonsters` 상태와 `assignMonster` 액션을 복구하여 시설 관리 화면의 런타임 에러(`TypeError`)를 해결했습니다.
- **방어 로직 강화**: `useAutoCollection` 등 루프 로직에서 데이터 로딩 지연으로 인한 `undefined` 참조 오류를 방지하기 위해 안전 장치를 추가했습니다.

## 2. 데이터 영속성 및 동기화 확장
- **몬스터 할당 실시간 저장**: 시설에 몬스터를 배치하거나 해제할 때 해당 정보가 Supabase DB(`player_facility`)에 즉시 또는 배치(Batch)로 저장되도록 동기화 시스템을 확장했습니다.
- **배치 동기화 최적화**: `useBatchSync` 기능을 개선하여 시설 레벨과 몬스터 할당 정보를 한 번의 요청으로 효율적으로 업데이트합니다.

## 3. 모바일 UI/UX 개선 및 에셋 최적화
- **아이콘 표시 오류 해결**: 모바일 시설 페이지에서 아이콘이 텍스트로 표시되던 문제를 Google Material Symbols font를 도입하여 해결했습니다.
- **시설 에셋 추가**: 이미지 파일이 누락되었던 '연금술 공방', '상점', '몬스터 농장' 등에 대해 고품질 픽셀 아트 이미지를 새로 생성하여 배치했습니다.
- **아이콘 매핑 최적화**: 시설 ID와 실제 이미지 파일명 사이의 매핑을 `idleConst.json` 구조에 맞게 통일했습니다.

## 4. 기타 에셋 및 데이터 수정
- **재료 아이콘 추가**: 누락되었던 `spectral_ectoplasm` 재료의 이미지를 생성하여 시스템에 통합했습니다.
- **전투 및 상점 UI 안정화**: 이전 작업에서 미진했던 전투 뷰의 텍스트 레이아웃 및 상점 판매 로직의 세부 사항을 조정했습니다.

# 업데이트 로그: 고급 연금술 시스템 및 DB 스키마 확장

## 1. 고급 연금술 시스템 통합
- **조건부 레시피 구현**: 시간, 날씨, 장치 등 다양한 조건에 따라 조합 가능 여부를 판단하는 로직 추가.
- **컨텍스트 기반 조합**: `AlchemyContext`를 통해 현재 게임 환경(시간, 위치 등)을 실시간으로 반영.
- **UI 통합**: `GameCanvas`에서 연금술 컨텍스트를 연동하여 실시간 상태 반영.

## 2. 데이터베이스 스키마 확장
- **몬스터 마스터 테이블 (`monster`) 생성**: 
  - 몬스터의 기본 스탯(HP, ATK, DEF), 속성, 역할, 등급 정보 저장.
  - `icon_url` 컬럼을 통해 이미지 리소스 관리 (로컬 에셋 연동).
- **재료 테이블 (`material`) 확장**: `sell_price` 컬럼 추가로 상점 판매 기능 지원.
- **레시피 조건 테이블 (`recipe_condition`) 고도화**: 다양한 조건 타입(JSON, Int, Text 등)을 유연하게 저장할 수 있도록 구조 변경.

## 3. 개발 환경 개선
- **Supabase CLI 타입 자동 생성**: 
  - DB 스키마 변경 시 `npm run types:generate` 명령어로 TypeScript 타입을 자동 동기화.
  - `database.types.ts`를 통해 Type-safe한 개발 환경 구축.

## 4. 데이터 마이그레이션
- **기초 데이터 추가**: 기본 슬라임, 골렘 등 10여 종의 몬스터 데이터 및 이미지 경로 매핑 완료.
- **테스트 레시피 추가**: 시간/조건부 특수 레시피 5종 추가.

## 5. 상점 판매 동기화 안정화
- **문제**: 레거시 자원 판매 시 DB 동기화가 실패해도 클라이언트가 즉시 재고를 차감하고 골드를 지급하여 실제 DB 상태와 불일치가 발생할 수 있었음.
- **개선**: `sellResource`를 비동기 함수로 전환해 DB 연동(consumeMaterials)이 성공했을 때만 로컬 자원 차감과 골드 지급이 이뤄지도록 변경하고, 판매 결과를 boolean으로 반환해 UI가 실패한 판매를 건너뛰도록 수정.

## 6. 신규 던전 및 몬스터 확장
- **신비한 호수 던전 추가**:
  - 물 속성 몬스터(워터 슬라임, 호수의 요정 등)가 등장하는 새로운 던전.
  - 던전 선택 UI를 통해 원하는 던전으로 입장 가능.
- **전투 UI 고도화**:
  - 아군 및 적군 몬스터 이미지 표시 (이모지 대체).
  - 전리품 로그 한글화 적용.
  - 몬스터 데이터 동기화 및 'Unknown' 이름 오류 수정.

# 2025-12-19 업데이트: 시스템 안정성 강화 및 데이터 동기화 수정

## 1. 빌드 및 배포 환경 최적화
- **빌드 오류 해결**: `vitest` 의존성 누락 및 TypeScript의 `import type` 관련 오류를 수정하여 Vercel 배포가 정상적으로 완료되도록 조치했습니다.
- **사전 검증 규칙 도입**: Git 푸시 전 런타임, 린트, 빌드를 필히 확인하도록 하는 [`PRE_PUSH_RULE.md`](file:///Users/jwonkim/Workspace/gemtleMonster/PRE_PUSH_RULE.md)를 작성하여 코드 품질 관리를 강화했습니다.

## 2. 런타임 에러 및 데이터 안정성 개선
- **Supabase API 406 오류 해결**: 프로필 조회나 자원 상태 확인 시 데이터가 없는 상황에서 발생하던 406 오류를 `.maybeSingle()` 도입을 통해 완벽히 제어했습니다.
- **몬스터 데이터 정합성 수정**: `monsterData.ts`의 문법 오류와 누락된 데이터(산타 골렘 등)를 복구했습니다.

## 3. 시설 동기화 시스템 개편 및 데이터 정합성 수정
- **배치 동기화 시스템 고도화**:
  - `last_collected_at`(최근 생산 시간)을 배치 동기화 대상에 추가하여, 생산 진행도가 세션 간에 정확히 유지되도록 개선했습니다.
  - 몬스터 배치 정보를 개별 슬롯 단위가 아닌 전체 배열 단위로 전송하여 데이터가 덮어씌워지는 현상을 방지했습니다.
  - 네트워크 오류 시 데이터를 큐에 재수집(Retry)하는 복구 로직을 추가하여 데이터 보존성을 높였습니다.
- **클로저 이슈 및 코드 구조 개선**:
  - `useBatchSync`의 상태 참조 문제를 최신 `Ref` 기반 콜백 시스템으로 해결하여 동기화 누락을 원천 차단했습니다.
  - `UIOverlay`를 제거하고 비시각적 시스템 로직을 `GameSystemConnector`로 통합하여 코드 관리를 일원화했습니다.
- **데이터베이스 호환성 강화**:
  - `assigned_monster_ids`(배열)와 `assigned_monster_id`(단일) 컬럼을 동시 관리하여 하위 호환성을 유지했습니다.

## 4. PWA 및 모바일 호환성 개선
- **메타 태그 업데이트**: `index.html`에 최신 모바일 환경을 위한 메타 태그를 추가했습니다.
- **앱 아이콘 경로 수정**: `manifest.json`에서 존재하지 않는 아이콘 경로로 인해 발생하던 404 오류를 기본 아이콘(`favicon.png`)으로 대체하여 해결했습니다.
