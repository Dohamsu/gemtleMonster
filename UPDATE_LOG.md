# 2025-12-02 업데이트: 연금술 조합 로직 개선 및 버그 수정

## 1. 연금술 조합 로직 개선
- **최소 수량 매칭 지원**: 정확한 수량이 아닌, 최소 필요 수량만 충족하면 조합이 가능하도록 변경했습니다. (예: 필요량보다 재료를 많이 넣어도 조합 성공)
- **최적 레시피 자동 선택**: 여러 레시피가 매칭될 경우, 재료를 가장 많이 소모하는(더 복잡한) 레시피가 우선적으로 선택되도록 로직을 개선했습니다.
## 2024-12-19
- **오프라인 보상 시스템 개선**
  - 기존 20% 효율 제한 제거 (100% 효율 적용)
  - 몬스터 배치 효과(속도, 생산량) 및 시설 생산 모드(저티어 생산) 반영 로직 추가
- **몬스터 초월(Awakening) 시스템 수정**
  - 초월 버튼 미작동 버그 수정 (이벤트 버블링 및 pointer-events 문제 해결)
  - 초월 재료 가치 가중치 적용 (재료의 초월 레벨만큼 가치 합산)
  - 최대 초월 레벨(5) 초과 방지 안전 장치 및 UI 경고 추가
- **전투 시스템 개선**
  - 전투 배속 기능 안정화 및 UI 수정

## 2024-12-18
## 2. 버그 수정
- **DB 함수 오류 수정**: `update_recipe_craft_count` 호출 시 발생하는 타입 불일치 오류를 수정하여 조합 카운트가 정상적으로 기록되도록 조치했습니다.

---

# 2025-12-18 업데이트: 시설 관리 시스템 안정화 및 모바일 UI 최적화

## 1. 시설 관리 및 자동 수집 시스템 복구
- **GameState 복구**: `useGameStore`에서 누락되었던 `assignedMonsters` 상태와 `assignMonster` 액션을 복구하여 시설 관리 화면의 런타임 에러(`TypeError`)를 해결했습니다.
- **방어 로직 강화**: `useAutoCollection` 등 루프 로직에서 데이터 로딩 지연으로 인한 `undefined` 참조 오류를 방지하기 위해 안전 장치를 추가했습니다.

## 2. 데이터 영속성 및 동기화 확장
- **몬스터 할당 실시간 저장**: 시설에 몬스터를 배치하거나 해제할 때 해당 정보가 Supabase DB(`player_facility`)에 즉시 또는 배치(Batch)로 저장되도록 동기화 시스템을 확장했습니다.
- **배치 동기화 최적화**: `useBatchSync` 기능을 개선하여 시설 레벨과 몬스터 할당 정보를 한 번의 요청으로 효율적으로 업데이트합니다.

## 3. 모바일 UI/UX 개선 및 에셋 최적화
- **아이콘 표시 오류 해결**: 모바일 시설 페이지에서 아이콘이 텍스트로 표시되던 문제를 Google Material Symbols font를 도입하여 해결했습니다.
- **시설 에셋 추가**: 이미지 파일이 누락되었던 '연금술 공방', '상점', '몬스터 농장' 등에 대해 고품질 픽셀 아트 이미지를 새로 생성하여 배치했습니다.
- **아이콘 매핑 최적화**: 시설 ID와 실제 이미지 파일명 사이의 매핑을 `idleConst.json` 구조에 맞게 통일했습니다.

## 4. 기타 에셋 및 데이터 수정
- **재료 아이콘 추가**: 누락되었던 `spectral_ectoplasm` 재료의 이미지를 생성하여 시스템에 통합했습니다.
- **전투 및 상점 UI 안정화**: 이전 작업에서 미진했던 전투 뷰의 텍스트 레이아웃 및 상점 판매 로직의 세부 사항을 조정했습니다.

# 업데이트 로그: 고급 연금술 시스템 및 DB 스키마 확장

## 1. 고급 연금술 시스템 통합
- **조건부 레시피 구현**: 시간, 날씨, 장치 등 다양한 조건에 따라 조합 가능 여부를 판단하는 로직 추가.
- **컨텍스트 기반 조합**: `AlchemyContext`를 통해 현재 게임 환경(시간, 위치 등)을 실시간으로 반영.
- **UI 통합**: `GameCanvas`에서 연금술 컨텍스트를 연동하여 실시간 상태 반영.

## 2. 데이터베이스 스키마 확장
- **몬스터 마스터 테이블 (`monster`) 생성**: 
  - 몬스터의 기본 스탯(HP, ATK, DEF), 속성, 역할, 등급 정보 저장.
  - `icon_url` 컬럼을 통해 이미지 리소스 관리 (로컬 에셋 연동).
- **재료 테이블 (`material`) 확장**: `sell_price` 컬럼 추가로 상점 판매 기능 지원.
- **레시피 조건 테이블 (`recipe_condition`) 고도화**: 다양한 조건 타입(JSON, Int, Text 등)을 유연하게 저장할 수 있도록 구조 변경.

## 3. 개발 환경 개선
- **Supabase CLI 타입 자동 생성**: 
  - DB 스키마 변경 시 `npm run types:generate` 명령어로 TypeScript 타입을 자동 동기화.
  - `database.types.ts`를 통해 Type-safe한 개발 환경 구축.

## 4. 데이터 마이그레이션
- **기초 데이터 추가**: 기본 슬라임, 골렘 등 10여 종의 몬스터 데이터 및 이미지 경로 매핑 완료.
- **테스트 레시피 추가**: 시간/조건부 특수 레시피 5종 추가.

## 5. 상점 판매 동기화 안정화
- **문제**: 레거시 자원 판매 시 DB 동기화가 실패해도 클라이언트가 즉시 재고를 차감하고 골드를 지급하여 실제 DB 상태와 불일치가 발생할 수 있었음.
- **개선**: `sellResource`를 비동기 함수로 전환해 DB 연동(consumeMaterials)이 성공했을 때만 로컬 자원 차감과 골드 지급이 이뤄지도록 변경하고, 판매 결과를 boolean으로 반환해 UI가 실패한 판매를 건너뛰도록 수정.

## 6. 신규 던전 및 몬스터 확장
- **신비한 호수 던전 추가**:
  - 물 속성 몬스터(워터 슬라임, 호수의 요정 등)가 등장하는 새로운 던전.
  - 던전 선택 UI를 통해 원하는 던전으로 입장 가능.
- **전투 UI 고도화**:
  - 아군 및 적군 몬스터 이미지 표시 (이모지 대체).
  - 전리품 로그 한글화 적용.
  - 몬스터 데이터 동기화 및 'Unknown' 이름 오류 수정.

# 2025-12-19 업데이트: 시설 생산 모드 전환 및 모바일 UI 고도화

## 1. 시설 생산 모드 전환 (Production Mode Switching)
- **데스크톱/모바일 지원**: 시설의 생산물 수준을 선택할 수 있는 기능을 추가했습니다. 이제 고레벨 시설에서도 저티어 재료를 생산할 수 있습니다.
- **고효율 모드 (High Efficiency Mode)**: 낮은 레벨의 생산 모드를 선택하더라도, 생산 속도와 수량은 **현재 시설의 실제 레벨**을 기준으로 적용됩니다. 이를 통해 저티어 재료를 매우 빠르게 대량 생산할 수 있습니다.
- **상태 관리**: 각 시설별 생산 모드 설정이 `useGameStore`에 저장되어 유지됩니다.

## 2. 모바일 UI/UX 개선
- **실시간 생산 현황 표시**: 모바일 시설 목록 카드에서 몬스터 배치 효과가 적용된 **실제 생산 주기와 수량**을 실시간으로 계산하여 표시합니다. (예: `1개 / 3.8초`)
- **시각적 프로그레스 바**: 생산 진행 상황을 직관적으로 보여주는 노란색 프로그레스 바를 추가했습니다. 크기와 위치를 최적화하여 정보 가독성을 높였습니다.
